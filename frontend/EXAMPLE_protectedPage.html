<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Protegida - Ejemplo</title>
    <link rel="stylesheet" href="css/header.css">
</head>
<body>
    <header>
        <h1>Sistema de Anestesiólogos del Valle</h1>
    </header>

    <main>
        <h2>Panel de Control</h2>

        <!-- Este botón solo lo verán los ADMIN -->
        <button id="admin-only-button" class="admin-only">
            Gestionar Usuarios (Solo Admin)
        </button>

        <!-- Este botón lo verán admin Y user -->
        <button id="view-schedule-button" class="all-users">
            Ver Programación
        </button>

        <!-- Este botón solo si tiene permiso para crear horarios -->
        <button id="create-schedule-button" class="permission-create-schedule">
            Crear Horario
        </button>

        <!-- Este input se deshabilitará si no tiene permiso para editar -->
        <div>
            <label>Nombre de usuario:</label>
            <input type="text" id="username-input" class="requires-edit-permission">
        </div>

        <!-- Tabla que solo el admin puede ver -->
        <div id="admin-panel" class="admin-only" style="display: none;">
            <h3>Panel de Administración</h3>
            <table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    <!-- Se llenará dinámicamente -->
                </tbody>
            </table>
        </div>

        <!-- Sección de mis vacaciones (todos pueden verla) -->
        <div id="my-vacations">
            <h3>Mis Vacaciones</h3>
            <button id="add-vacation-button">Agregar Vacaciones</button>
            <ul id="vacations-list"></ul>
        </div>
    </main>

    <script type="module">
        import {
            initializePermissions,
            hasPermission,
            hasRole,
            isAdmin,
            showIfHasRole,
            showIfHasPermission,
            disableIfNoPermission,
            redirectIfNoRole
        } from './js/authUtils.js';

        document.addEventListener('DOMContentLoaded', async function() {

            // =========================================
            // 1. Inicializar sistema de permisos
            // =========================================
            await initializePermissions();

            // =========================================
            // 2. Proteger la página completa (opcional)
            // =========================================
            // Solo usuarios autenticados pueden estar aquí
            // redirectIfNoRole('/login.html', 'admin', 'user');

            // =========================================
            // 3. Mostrar/ocultar elementos por ROL
            // =========================================

            // Solo mostrar a admin
            showIfHasRole('.admin-only', 'admin');

            // Mostrar a admin y user
            showIfHasRole('.all-users', 'admin', 'user');

            // =========================================
            // 4. Mostrar/ocultar por PERMISO específico
            // =========================================

            // Solo mostrar botón de crear horario si tiene permiso
            showIfHasPermission('.permission-create-schedule', 'weeklySchedule', 'create');

            // =========================================
            // 5. Deshabilitar elementos sin permiso
            // =========================================

            // Deshabilitar input si no tiene permiso de editar usuarios
            disableIfNoPermission('.requires-edit-permission', 'users', 'update');

            // =========================================
            // 6. Lógica condicional en código
            // =========================================

            // Cargar datos según el rol
            if (isAdmin()) {
                console.log('Cargando panel de administración...');
                await loadAdminPanel();
            } else {
                console.log('Usuario regular, cargando vista limitada...');
            }

            // =========================================
            // 7. Event listeners con verificación
            // =========================================

            document.getElementById('create-schedule-button')?.addEventListener('click', () => {
                if (hasPermission('weeklySchedule', 'create')) {
                    console.log('Creando horario...');
                    // Lógica para crear horario
                } else {
                    alert('No tienes permisos para crear horarios.');
                }
            });

            document.getElementById('admin-only-button')?.addEventListener('click', () => {
                if (isAdmin()) {
                    console.log('Abriendo panel de gestión de usuarios...');
                    // Lógica de gestión de usuarios
                } else {
                    alert('Solo los administradores pueden acceder a esta función.');
                }
            });
        });

        // Función de ejemplo para cargar el panel de admin
        async function loadAdminPanel() {
            const apiUrl = window.location.hostname === 'localhost'
                ? 'http://localhost:3000'
                : 'https://advalle-46fc1873b63d.herokuapp.com';

            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');

                const response = await fetch(`${apiUrl}/users/roles`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('users-table');

                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>
                                <span style="
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    background-color: ${user.role === 'admin' ? '#dc3545' : '#28a745'};
                                    color: white;
                                    font-size: 12px;
                                ">
                                    ${user.role.toUpperCase()}
                                </span>
                            </td>
                            <td>
                                <button onclick="changeRole('${user._id}', '${user.role === 'admin' ? 'user' : 'admin'}')">
                                    Cambiar a ${user.role === 'admin' ? 'User' : 'Admin'}
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error cargando panel de admin:', error);
            }
        }

        // Función para cambiar rol (solo admin puede hacer esto)
        window.changeRole = async function(userId, newRole) {
            const apiUrl = window.location.hostname === 'localhost'
                ? 'http://localhost:3000'
                : 'https://advalle-46fc1873b63d.herokuapp.com';

            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');

                const response = await fetch(`${apiUrl}/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newRole })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    location.reload(); // Recargar para ver cambios
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.message);
                }
            } catch (error) {
                console.error('Error cambiando rol:', error);
                alert('Error al cambiar el rol');
            }
        }
    </script>
</body>
</html>
